# 🍎 FruitOPS 系統運作流程 - 完整簡報指南

---

## 📑 目錄

1. [系統架構](#系統架構)
2. [用戶工作流程](#用戶工作流程)
3. [數據流向](#數據流向)
4. [決策引擎](#決策引擎)
5. [AI 助手工作流](#ai-助手工作流)
6. [常見操作指南](#常見操作指南)

---

# 系統架構

## 整體系統組成

```
┌─────────────────────────────────────────────────────────────┐
│                     FruitOPS 智能果園系統                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              前端 (React 19 + TypeScript)             │   │
│  │  ┌─────────────┬─────────────┬─────────────────────┐ │   │
│  │  │ Dashboard   │ Production  │ Inventory           │ │   │
│  │  │ (總覽/圖表) │ (地塊管理)  │ (多位置庫存)        │ │   │
│  │  └─────────────┴─────────────┴─────────────────────┘ │   │
│  │  ┌─────────────┬─────────────┬─────────────────────┐ │   │
│  │  │ Orders      │ CRM         │ Calendar            │ │   │
│  │  │ (訂單/揀貨) │ (客戶分級)  │ (季節行事曆)        │ │   │
│  │  └─────────────┴─────────────┴─────────────────────┘ │   │
│  │  ┌─────────────────────────────────────────────────┐ │   │
│  │  │  全局 Toast 通知系統 (實時反饋)                  │ │   │
│  │  └─────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓↑                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           後端 API (Express + Node.js)                │   │
│  │  ┌─────────────────────────────────────────────────┐ │   │
│  │  │ RESTful 端點                                     │ │   │
│  │  │ /api/products  /api/plots  /api/inventory      │ │   │
│  │  │ /api/orders    /api/customers /api/logs        │ │   │
│  │  │ /api/customers/segmentation (RFM 計算)         │ │   │
│  │  │ /api/ai-advice (Gemini AI 諮詢)                │ │   │
│  │  └─────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓↑                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │    資料庫 (PostgreSQL on Supabase)                    │   │
│  │  ┌──────────┬──────────┬──────────┬──────────────┐  │   │
│  │  │ products │ plots    │ inventory│ orders       │  │   │
│  │  │ customers│ logs     │ locations│ order_items  │  │   │
│  │  └──────────┴──────────┴──────────┴──────────────┘  │   │
│  └──────────────────────────────────────────────────────┘   │
│                            ↓↑                                 │
│  ┌──────────────────────────────────────────────────────┐   │
│  │      AI 助手 (Google Gemini API)                      │   │
│  │  - 實時咨詢 (生產、銷售、成本)                         │   │
│  │  - 智能建議 (促銷、清倉、防蟲)                         │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

# 用戶工作流程

## 📋 典型使用場景 1: 每日上班流程

```
┌─────────────────────────────────────────────────────────┐
│ 🌅 經理上班第一件事：打開系統看 Dashboard               │
└─────────────────────────────────────────────────────────┘
                            ↓
        ┌───────────────────────────────────────┐
        │ Dashboard 自動顯示：                  │
        │ • 本月水果產銷狀況（圖表）             │
        │ • 本月銷售額（僅已完成訂單）           │
        │ • 本月完成訂單數量                    │
        │ • 今月優先推薦品項                    │
        │ • 即將過期庫存警告                    │
        │ • 待處理訂單數量                      │
        │ • VIP 客戶動態（自動從資料庫識別）     │
        └───────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 檢查「智慧生產」→ Production 頁面                   │
        │ • 查看所有地塊健康分數                              │
        │ • 按優先度排序（≥85 觀察/60-84 注意/<60 優先）    │
        │ • 點擊地塊查看最近農事紀錄                          │
        │ • 點擊「諮詢 AI」提問今日農務                      │
        └─────────────────────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 檢查「分級庫存」→ Inventory 頁面                    │
        │ • 查看多位置庫存摘要                                │
        │ • 識別優先促銷品項（>14天或 C 級高庫存）          │
        │ • 查看每日進出（新增/移位）                        │
        │ • 通路建議：新鮮→直售/LINE，即期→批發清倉        │
        └─────────────────────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 檢查「訂單管理」→ Orders 頁面                       │
        │ • 查看待處理訂單 (Pending 狀態)                    │
        │ • 系統建議推薦客戶 (加權 RFM 高分)                │
        │ • 系統推薦優先品項 (即期庫存多)                   │
        │ • 為待揀訂單指定儲位→確認→扣庫存                  │
        └─────────────────────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 定期檢查「CRM 客戶管理」→ CRM 頁面 (每週)          │
        │ • 點擊「計算 RFM 分級」→系統自動分析               │
        │ • 預覽分級變化                                      │
        │ • 點擊「套用分級」→更新客戶檔案                    │
        │ • 針對 At Risk 客戶進行挽回活動                    │
        └─────────────────────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 季節規劃「行事曆」→ Calendar 頁面 (每月/季度)      │
        │ • 查看月份水果供應與推薦策略                        │
        │ • 規劃下月促銷活動與庫存預估                        │
        │ • 參考歷史數據決定預購/通路配置                    │
        └─────────────────────────────────────────────────────┘
                            ↓
        ┌─────────────────────────────────────────────────────┐
        │ 🎉 系統自動發送 Toast 通知所有操作結果              │
        │ ✅ 「庫存已新增 20 箱水蜜桃」                       │
        │ ✅ 「訂單已確認，已扣庫存」                         │
        │ ❌ 「揀貨失敗：儲位庫存不足」                       │
        │ ℹ️  「地塊健康度已更新」                            │
        └─────────────────────────────────────────────────────┘
```

---

## 📊 典型使用場景 2: 訂單到揀貨完成流程

```
┌──────────────────────────────────────────────────────┐
│ 🛒 客戶下訂單（線上/電話）→ 進入系統待處理佇列       │
│ 狀態：Pending 🟡                                      │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 進銷員打開 Orders 頁面                               │
│ • 系統自動計算加權 RFM 推薦指數                       │
│ • 前 10 名建議客戶顯示，助推銷員發現銷售機會         │
│ • 同時標示優先促銷品項（即期/高庫存）               │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 進銷員新增訂單（快速操作）                           │
│ 1. 選擇客戶（客戶檔案直接可見 RFM 分級）             │
│ 2. 選擇水果品項                                      │
│ 3. 系統動態載入該品項可用品級（↓ 按 grade_id 排序） │
│    例：選「水蜜桃」→ [A級, B級, C級] 動態顯示       │
│ 4. 輸入數量 & 單位價格                               │
│ 5. 確認訂單                                          │
│ 狀態改為：Confirmed 🟢                               │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統 Toast 通知：                                    │
│ ✅ 「訂單 #ORD-20251219-001 已確認」                 │
│ ℹ️  「等待揀貨指派」                                 │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 揀貨員看到待揀訂單                                   │
│ • 進入「揀貨」功能（Orders 頁面）                    │
│ • 系統顯示：每筆訂單品項、數量、品級需求             │
│ • 揀貨員手動選擇儲位（Location + Grade）             │
│ • 確認揀貨 → 系統自動：                             │
│   - 計算出庫數量                                     │
│   - 減扣該儲位庫存                                   │
│   - 更新庫存摘要 (v_inventory_summary)              │
│   - 訂單狀態改為 Shipped 🔵                         │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統 Toast 通知：                                    │
│ ✅ 「揀貨完成！已扣庫存 20 箱 (水蜜桃-A級)」        │
│ ✅ 「訂單 #ORD-20251219-001 已出貨」                 │
│ ℹ️  「庫存剩餘：50 箱」                              │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 📦 配送→ 客戶收貨 → 進銷員標記「已交付」            │
│ 狀態改為：Completed ⚪                               │
│ • 訂單自動計入 RFM Recency & Frequency 計算          │
└──────────────────────────────────────────────────────┘
```

---

## 🌾 典型使用場景 3: 新鮮採收入庫流程

```
┌──────────────────────────────────────────────────────┐
│ 🌳 田間採收完成 → 進銷員在 Inventory 新增入庫        │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 打開「Inventory」→「新增庫存」                      │
│ 填寫表單：                                           │
│ • 品項（Product）：選擇水蜜桃                        │
│ • 品級（Grade）：A / B / C                           │
│ • 數量（Quantity）：100 箱                          │
│ • 位置（Location）：北倉 / 南倉 / 中繼倉             │
│ • 採收日期（harvest_date）：2025-12-19（必填！）   │
│ • 規格（package_spec）：12 粒裝 / 5kg 裝            │
│ • 批號（batch_id）：BATCH-001                       │
│ • 來源地塊（origin_plot_id）：Plot-A01（可選）     │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統自動計算並顯示：                                │
│ • agingDays：0（剛採收）                            │
│ • 時效分期：🟢 新鮮期                               │
│ • 建議通路：直接銷售 / LINE 預購 / VIP 電話         │
│ • 預期售出期限：5-7 天內                            │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 確認新增 → 系統：                                    │
│ ✅ 「庫存新增成功！」                                │
│ ℹ️  「100 箱水蜜桃(A級) 已入庫 (北倉)」             │
│ 📊 庫存摘要自動更新                                  │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統每日自動監控：                                   │
│ • Day 1-3：✅ 新鮮期 A 級 → 優先直銷                │
│ • Day 4-7：🔵 新鮮期 B/C 級 → 推 LINE/電話          │
│ • Day 8-14：🟠 保鮮期 → 轉向批發清倉               │
│ • Day 15+：🔴 展示期 → 紅字警告 + 降價提醒          │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 進銷員在 Inventory 頁面「優先促銷品項」看到：        │
│ 🔴 「水蜜桃-A級 即將過期（12 天），庫存 30 箱」     │
│ 💡 建議：「立即打電話給 VIP 客戶，推批發清倉」      │
│                                                      │
│ 點擊「諮詢 AI」：                                    │
│ 「我有 30 箱水蜜桃即將過期，怎樣快速銷售？」        │
│ AI 回答：「建議組合包：5kg+蜜蘋果+梨子＄199/套」    │
└──────────────────────────────────────────────────────┘
```

---

## 🧠 典型使用場景 4: AI 顧問諮詢流程

```
┌──────────────────────────────────────────────────────┐
│ 進銷員在任何頁面發現問題 → 點擊「諮詢 AI」按鈕      │
│ 可用頁面：Production / Inventory / Orders / Dashboard│
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統準備背景資訊（取決於當前頁面）：                │
│                                                      │
│ 若在 Production：                                   │
│ • 當前地塊健康分數、狀態、最近農事                   │
│ • 該地塊種植的水果、季節性預期                       │
│                                                      │
│ 若在 Inventory：                                    │
│ • 當前庫存摘要、各品項存期、品級分佈                │
│ • 通路銷售績效、滯銷品項清單                         │
│                                                      │
│ 若在 Orders：                                       │
│ • 待揀/待出訂單、推薦客戶清單                       │
│ • 銷售額、平均訂單價值、高價值客戶                   │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 進銷員輸入提問：                                    │
│ 例1（Production）：「地塊A今年冬季蘋果怎樣管理？」  │
│ 例2（Inventory）：「我現在有 50 箱過期果，怎辦？」  │
│ 例3（Orders）：「怎樣提升 At Risk 客戶回購？」      │
│ 例4（Dashboard）：「下月推什麼主力品項好？」        │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統後端 (/api/ai-advice)：                         │
│ 1. 收集上下文（當前頁面數據 + 提問）                │
│ 2. 組裝 Prompt：「您是果園經營顧問，根據以下資料... │
│    當前地塊/庫存/客戶狀況是... 使用者提問是...      │
│    請給出 3-5 條具體建議」                          │
│ 3. 調用 Google Gemini API（超時 10 秒）           │
│ 4. 流式返回 AI 回答                                 │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ Production 頁面的 AI 回答窗口實時顯示：             │
│                                                      │
│ 「根據您地塊 A 的當前狀況，冬季蘋果管理建議：      │
│  1. 修剪：移除病枝，改善日照（預計加 5 分）       │
│  2. 防凍：準備防霜措施，預警低溫預報                │
│  3. 施肥：冬季萌芽前施一次磷鉀肥，強化花芽         │
│  4. 病蟲防治：3-5 天巡檢一次，重點看介殼蟲         │
│  5. 預期產量：若管理好，春季可增產 15-20%」        │
│                                                      │
│ + 系統自動建立日誌記錄：                            │
│   「AI 顧問建議：冬季蘋果修剪防凍」                 │
│   (可在 Production 日誌查看歷史)                    │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│ 系統 Toast 通知：                                    │
│ ✅ 「AI 咨詢日誌已保存」                             │
│ 📝 「記錄 ID: LOG-20251219-XYZ」                     │
└──────────────────────────────────────────────────────┘
```

---

# 數據流向

## 🔄 典型數據流動（以訂單為例）

```
客戶端 (React)                    後端 (Express)              資料庫 (PostgreSQL)
─────────────────────────────────────────────────────────────────────────────────

[Orders 頁面]
  ↓
[用戶點選「新增訂單」]
  ↓
┌─────────────────────┐
│ 表單彈窗打開         │         ← 初始化：取得產品列表
│ GET /api/products   │───────→ SELECT * FROM products
│                     │←────────  [{id, name, ...}, ...]
└─────────────────────┘
  ↓
[用戶選擇水蜜桃]
  ↓
┌─────────────────────┐
│ 動態載入品級         │         ← 取得特定品項的可用品級
│ GET /api/products   │
│ /:id/grades         │───────→ SELECT DISTINCT grade_id 
│                     │         FROM inventory 
│                     │         WHERE product_id = ? 
│                     │         AND quantity > 0
│                     │←────────  [{id: 'A', ...}, {id: 'B', ...}]
└─────────────────────┘
  ↓
[用戶填寫：客戶、品項、數量、價格 → 確認]
  ↓
┌──────────────────────┐
│ 新增訂單              │         ← 驗證 & 插入訂單
│ POST /api/orders     │───────→ INSERT INTO orders 
│ {                    │         (customer_id, status, ...)
│   customer_id,       │         VALUES (...)
│   items: [{product,  │         RETURNING id
│   grade, qty, price}]│
│ }                    │         INSERT INTO order_items 
│                      │         (order_id, product_id, ...)
│                      │         (多筆)
│                      │
│                      │←────────  {id: 'ORD-123', status: 'Confirmed', ...}
└──────────────────────┘
  ↓ [接收成功回應]
  ↓
┌────────────────────────┐
│ 前端 dispatch 更新狀態 │
│ • orderList 追加新訂單 │
│ • Toast: ✅ 訂單已新增 │
└────────────────────────┘
  ↓
[使用者看到 Toast 通知]
  ↓
[進入「揀貨」模式]
  ↓
┌──────────────────────────┐
│ 前端取得待揀訂單          │         ← 取得待揀訂單清單
│ GET /api/orders          │
│ ?status=Confirmed        │───────→ SELECT * FROM orders 
│                          │         WHERE status = 'Confirmed'
│                          │         ORDER BY created_at
│                          │
│                          │←────────  [{id, items: [...], ...}, ...]
└──────────────────────────┘
  ↓
[使用者為每項品項選擇儲位]
  ↓
┌─────────────────────────┐
│ 揀貨確認                 │         ← 更新訂單 & 扣庫存
│ POST /api/orders        │
│ /:id/pick               │───────→ BEGIN TRANSACTION
│ {                       │
│   items: [              │         UPDATE orders 
│    {product_id, grade,  │         SET status = 'Shipped'
│     location, qty}      │
│   ]                     │         UPDATE inventory 
│ }                       │         SET quantity = quantity - ? 
│                         │         WHERE location_id = ? 
│                         │         AND grade_id = ?
│                         │
│                         │         INSERT INTO v_inventory_summary
│                         │         (更新庫存摘要視圖)
│                         │
│                         │         COMMIT
│                         │
│                         │←────────  {success: true, 
│                         │           msg: "Picked successfully"}
└─────────────────────────┘
  ↓
┌──────────────────────────┐
│ 前端更新 UI              │
│ • 訂單狀態改為 Shipped   │
│ • Toast: ✅ 揀貨完成     │
│ • 庫存摘要自動重整       │
└──────────────────────────┘
  ↓
[使用者看到最新庫存摘要]
```

---

## 📊 RFM 計算數據流

```
CRM 頁面 (React)              後端 /api/customers/segmentation    資料庫 (PostgreSQL)
─────────────────────────────────────────────────────────────────────────────────

[進銷員點「計算 RFM 分級」]
  ↓
┌─────────────────────────┐
│ POST /calculate         │────────→ 1. 取得所有客戶 & 訂單歷史
│ (無參數)                 │          SELECT c.id, 
│                         │          MAX(o.created_at) as last_purchase,
│                         │          COUNT(o.id) as order_count,
│                         │          COALESCE(SUM(oi.qty * oi.price), 0) as total_spent
│                         │          FROM customers c
│                         │          LEFT JOIN orders o ON c.id = o.customer_id
│                         │          LEFT JOIN order_items oi ON o.id = oi.order_id
│                         │          GROUP BY c.id
│                         │
│                         │       2. 為每個客戶計算 R/F/M 分數
│                         │          R分 = IF(days_since_purchase ≤ 7, 5, ...)
│                         │          F分 = IF(order_count ≥ 20, 5, ...)
│                         │          M分 = IF(total_spent ≥ 50000, 5, ...)
│                         │
│                         │       3. 套用分級規則
│                         │          IF (R+F+M ≥ 13 AND M ≥ 4) THEN 'VIP'
│                         │          ELSE IF (R+F+M 9-12 AND R ≥ 3) THEN 'Stable'
│                         │          ...
│                         │
│                         │←────────  [{customer_id, R, F, M, segment, ...}, ...]
└─────────────────────────┘
  ↓
┌────────────────────────────────┐
│ 前端顯示計算結果預覽           │
│ • 表格：客戶名稱、R/F/M分、分級│
│ • 統計：VIP x5, Stable x12...  │
│ • 變化提示：「新增 VIP 客戶」  │
└────────────────────────────────┘
  ↓
[進銷員點「套用分級」]
  ↓
┌─────────────────────────┐
│ PUT /apply              │────────→ UPDATE customers 
│ (套用上次計算結果)       │          SET segment = ?, 
│                         │          r_score = ?, 
│                         │          f_score = ?, 
│                         │          m_score = ?,
│                         │          last_segmented = NOW()
│                         │          WHERE id IN (...)
│                         │
│                         │←────────  {success: true, 
│                         │           updated: 47}
└─────────────────────────┘
  ↓
┌────────────────────────────┐
│ 前端更新客戶卡片           │
│ • 分級標籤更新（🟣🔵🟢等）  │
│ • Toast: ✅ 分級已套用    │
└────────────────────────────┘
  ↓
[系統後續應用]
  ↓
[Orders 頁面顯示加權 RFM 推薦客戶]
  ├─ GET /api/customers?segment=VIP,Stable
  ├─ 前端計算加權分數 = 0.4*R + 0.3*F + 0.3*M
  ├─ 排序並顯示前 10 名
  └─ 進銷員優先聯絡高分客戶
```

---

# 決策引擎

## 🎯 優先促銷品項識別邏輯

```
系統每次載入 Inventory 頁面時自動計算：

FOR EACH 庫存品項 DO:
  agingDays = (TODAY - harvest_date) 天數
  
  IF agingDays > 14 且 quantity > 50 THEN
    優先度 = 🔴 紅色 (CRITICAL)
    建議 = 「立即清倉或加工！」
    
  ELSE IF agingDays > 10 且 quantity > 50 THEN
    優先度 = 🔴 紅色 (URGENT)
    建議 = 「立即降價或批發」
    
  ELSE IF agingDays > 7 且 quantity > 100 THEN
    優先度 = 🟠 橙色 (HIGH)
    建議 = 「組合促銷、會員優惠」
    
  ELSE IF agingDays > 7 且 grade = 'C' 且 quantity > 80 THEN
    優先度 = 🟠 橙色 (HIGH)
    建議 = 「C級品+時效→限時特價」
    
  ELSE IF agingDays 5-7 且 quantity > 150 THEN
    優先度 = 🟡 黃色 (MEDIUM)
    建議 = 「LINE 預購、電話推銷」
    
  ELSE
    優先度 = 🟢 綠色 (NORMAL)
    建議 = 「維持正常銷售節奏」
  END IF
END FOR

OUTPUT: 
  優先品項列表 (按優先度排序) → 在 Inventory 最上方顯示
  每項帶有實時建議 & 「諮詢 AI」按鈕
```

---

## 👥 加權 RFM 推薦客戶邏輯

```
Orders 頁面每次打開時自動計算：

FOR EACH 客戶 DO:
  取得該客戶的 RFM 分數 (R_score, F_score, M_score)
  
  加權總分 = 0.4 × R_score + 0.3 × F_score + 0.3 × M_score
  
  IF 加權總分 ≥ 3.5 THEN
    列入推薦清單
  END IF
END FOR

SORT BY 加權總分 DESC
取前 10 名客戶

FOR EACH 推薦客戶 DO
  顯示：客戶名稱、分級標籤（🟣VIP 等）、加權分數、最後購買日期
END FOR

UI 提示：「建議優先聯絡這些高價值客戶以推動新訂單」
```

---

## 🌡️ 地塊健康度計算

```
Production 頁面實時計算每個地塊的健康分數：

基礎分數 = 
  IF status = 'Active' THEN 80 分
  ELSE IF status = 'Maintenance' THEN 60 分
  ELSE IF status = 'Fallow' THEN 40 分

日誌貢獻（過去 7 天內，限計一次）：
  施肥 (Fertilize) +5
  修剪 (Pruning) +4
  噴藥 (Pesticide) +3
  套袋 (Bagging) +3
  除草 (Weeding) +2
  採收 (Harvest) +2

時效衰減（無作業天數）：
  IF 無作業 30-60 天 THEN -5 分
  ELSE IF 無作業 > 60 天 THEN -15 分

成本效益調整：
  IF 近 30 天總成本 < 500 THEN -3 分（投入不足）
  ELSE IF 近 30 天總成本 > 2000 AND 健康度 < 70 THEN -5 分

季節匹配（可選）：
  IF 錯季種植 THEN -5 分

最終健康度 = CLAMP(基礎 + 日誌 + 衰減 + 成本 + 季節, 0, 100)

決策：
  IF 健康度 ≥ 85 THEN 「✓ 健康良好」→ 保持現狀，巡檢即可
  ELSE IF 健康度 60-84 THEN 「⚠ 中度注意」→ 施肥、補水、防蟲
  ELSE THEN 「🚨 優先處理」→ 修剪、檢查灌溉、必要時施藥
```

---

## 📦 庫存時效分期決策

```
Inventory 頁面自動分類每筆庫存項目：

FOR EACH 庫存品項 DO
  agingDays = (TODAY - harvest_date)
  
  IF agingDays ≤ 7 THEN
    分期 = 「🟢 新鮮期」
    通路推薦 = [直接銷售, LINE, 電話]
    期望回轉 = 5-7 天
    定價 = 基準價 × 1.0 (100%)
    
  ELSE IF 7 < agingDays ≤ 14 THEN
    分期 = 「🔵 保鮮期」
    通路推薦 = [批發, 組合包]
    期望回轉 = 7-14 天
    定價 = 基準價 × 0.85-0.95 (打折)
    
  ELSE
    分期 = 「🟠 展示期」
    通路推薦 = [清倉、加工、福利品]
    期望回轉 = 立即清出
    定價 = 基準價 × 0.5-0.7 (清倉價)
    警告 = 🔴 「即將過期」
    
  END IF
END FOR

UI 呈現：
  左側分類選項卡 → 切換 [新鮮期 | 保鮮期 | 展示期]
  摘要統計 → 各分期庫存數量與金額
  明細表格 → 每項品項的建議通路與定價
```

---

# AI 助手工作流

## 🤖 AI 顧問完整流程圖

```
┌──────────────────────────────┐
│ 使用者在任何頁面看到         │
│「諮詢 AI」按鈕               │
└──────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 前端準備上下文信息：                    │
│                                          │
│ 若當前頁面 = Production：                │
│ context = {                              │
│   current_plot: {id, name, status, ...}, │
│   recent_logs: [...],                    │
│   health_score: 75,                      │
│   ...                                    │
│ }                                        │
│                                          │
│ 若當前頁面 = Inventory：                 │
│ context = {                              │
│   inventory_summary: [...],              │
│   aging_items: [...],                    │
│   channel_performance: {...},            │
│   ...                                    │
│ }                                        │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 使用者點擊「諮詢 AI」                    │
│ 或點擊某項品項的「AI 建議」按鈕         │
│ → 彈窗打開，顯示輸入框                  │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 使用者輸入提問：                        │
│ 「我這個地塊最近健康度下降，怎樣改善？」│
│ 或                                       │
│ 「50 箱梨子，12 天沒賣出，怎樣清倉？」  │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 前端 POST /api/ai-advice                 │
│ {                                        │
│   prompt: "使用者的提問",                 │
│   context: {...},                        │
│   page: "Production/Inventory/..."       │
│ }                                        │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 後端 (/server/index.js)：               │
│                                          │
│ 1. 接收請求                             │
│ 2. 組裝完整 Prompt：                     │
│    「你是一位有 20 年經驗的果園經營顧問」 │
│    「根據以下當前信息：...               │
│    「使用者提問：...                     │
│    「請提供 3-5 條具體、可執行的建議」    │
│                                          │
│ 3. 調用 Google Gemini API                │
│    (設置 10 秒超時)                      │
│                                          │
│ 4. 接收 AI 回答（流式或完整）            │
│ 5. 返回前端                              │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 前端實時流式顯示 AI 回答：                │
│                                          │
│ 「根據您當前情況，以下是建議：          │
│  1. 立即修剪病枝...                     │
│  2. 檢查灌溉系統...                     │
│  3. 施加磷鉀肥...                       │
│  4. 監控低溫預報...」                   │
│                                          │
│ 同時顯示「保存日誌」按鈕                 │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 使用者可選：點擊「保存日誌」             │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 前端 POST /api/logs                      │
│ {                                        │
│   plot_id: "當前地塊 ID",                │
│   log_type: "AIAdvice",                  │
│   content: "使用者提問 + AI 回答",        │
│   date: TODAY                            │
│   // id 留空，讓後端生成 UUID            │
│ }                                        │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 後端：                                   │
│ 1. 驗證表單（id 為可選）                 │
│ 2. 生成 UUID (randomUUID())              │
│ 3. INSERT INTO logs (自動使用 UUID)     │
│ 4. 若使用 Supabase，省略 id 讓 DB 默認  │
│ 5. 返回 {success: true, logId: ...}    │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 前端 Toast 通知：                        │
│ ✅ 「AI 咨詢已保存到農事日誌」           │
│ ℹ️  「您可以在『日誌』頁面查看」         │
└──────────────────────────────────────────┘
           ↓
┌──────────────────────────────────────────┐
│ 系統後續：                               │
│ • 該日誌自動關聯到當前地塊 (plot_id)    │
│ • 下次查看該地塊時，日誌自動顯示        │
│ • Production 頁面「農事日誌」列表更新   │
│ • RFM 客戶分級計算可參考該日誌時間      │
└──────────────────────────────────────────┘
```

---

# 常見操作指南

## 📋 快速操作清單

### 1️⃣ 每日上班檢查清單 (5-10 分鐘)

```
□ 打開 Dashboard
  • 查看本月銷售趨勢圖表
  • 檢查本週推薦品項
  • 確認待處理訂單數

□ 檢查「智慧生產」Production
  • 找出健康度 < 60 的地塊 → 點擊查看
  • 點擊「諮詢 AI」詢問今日農務
  • 檢查最近 3 天新增的農事日誌

□ 檢查「分級庫存」Inventory
  • 查看「優先促銷品項」（紅/橙色標記）
  • 若有 > 14 天庫存 → 立即聯絡 AI
  • 檢查昨日新增庫存是否正確入帳

□ 檢查「訂單管理」Orders
  • 查看「待揀訂單」數量
  • 檢查系統推薦的「高價值客戶」
  • 為待揀訂單分配揀貨任務
```

### 2️⃣ 庫存入庫操作 (10 分鐘)

```
1. 打開 Inventory → 「新增庫存」
2. 填寫表單：
   • 產品 = 選擇（下拉選單）
   • 品級 = A / B / C
   • 數量 = 輸入箱數
   • 位置 = 選擇儲位
   • 採收日期 = 日期選擇器（必填！決定時效）
   • 規格 = 選擇或輸入（12 粒裝、5kg 裝等）
   • 批號 = 可選（追溯用）
3. 確認 → 系統自動計算時效分期 & 通路建議
4. 檢查 Toast 通知確認成功
```

### 3️⃣ 新增訂單操作 (5-8 分鐘)

```
1. 打開 Orders → 「新增訂單」
2. 填寫訂單表單：
   • 客戶 = 搜尋/選擇（顯示 RFM 分級標籤）
   • 水果品項 = 選擇（自動載入可用品級）
   • 品級 = 從動態載入的選項選擇
   • 數量 = 輸入
   • 單位價格 = 輸入
   • +「新增品項」可多選
3. 確認訂單 → 狀態改為 Confirmed
4. 進入「揀貨」流程：
   • 選擇該訂單
   • 為每個品項分配儲位
   • 確認揀貨 → 系統自動扣庫存 & 更新狀態為 Shipped
```

### 4️⃣ RFM 分級操作 (10 分鐘，每週執行)

```
1. 打開 CRM 頁面
2. 點擊「計算 RFM 分級」
3. 系統自動計算所有客戶的 R/F/M 分數
4. 預覽分級變化（表格顯示）
5. 確認無誤後點「套用分級」
6. 系統更新所有客戶檔案的分級標籤
7. 下次打開 Orders 頁面時，推薦客戶自動按新分級排序
```

### 5️⃣ AI 諮詢操作 (5 分鐘)

```
在任何頁面上方看到「諮詢 AI」按鈕：

1. 點擊按鈕 → 彈窗打開
2. 輸入提問：
   例："最近這地塊病蟲害多，怎樣防治？"
   或："50 箱水蜜桃，12 天賣不出，怎樣清倉？"
3. 點「提交」或按 Enter
4. 等待 AI 回答（3-5 秒）
5. 實時看到 AI 建議顯示
6. 可選「保存日誌」記錄這次諮詢
7. Toast 通知確認保存成功
```

### 6️⃣ 庫存移位操作 (3-5 分鐘)

```
在 Inventory 明細表格中：

1. 找到要移位的庫存項
2. 點擊「移位」按鈕
3. 選擇目標儲位
4. 輸入移位數量（可部分移位）
5. 確認 → 系統更新
6. 驗證摘要表中該品項數量已轉移
```

---

## ⚡ 常見問題速查表

| 問題 | 解決方案 |
|------|---------|
| 新增庫存後看不到 | 確認已填「採收日期」，摘要可能需要刷新 |
| 訂單無法確認 | 檢查客戶是否存在，品級是否有庫存 |
| 揀貨失敗 | 選定的儲位庫存可能不足，選其他儲位 |
| AI 服務錯誤 | 確認 GEMINI_API_KEY 已設定在 .env |
| 日誌無法保存 | 檢查網路連線，確認 Supabase 連線正常 |
| 地塊健康度不變 | 確認有新增農事日誌或調整狀態 |
| RFM 分級未更新 | 確認訂單已確認並計入銷售額 |

---

## 🎯 業務目標與系統對標

| 業務目標 | 系統支撐方式 |
|---------|-----------|
| 減少庫存滯銷 | 優先促銷品項 + 時效分期 + AI 建議 |
| 提升客戶回購 | RFM 分級 + 加權推薦 + 針對性促銷 |
| 提高地塊產量 | 健康度監控 + AI 防蟲/施肥建議 |
| 加快訂單處理 | 快速新增 + 揀貨自動扣庫存 |
| 優化通路配置 | 時效 + 品級自動推薦最佳通路 |
| 降低成本 | AI 成本優化建議 + 數據驅動決策 |

---

## 🔐 數據安全檢查清單

```
✅ 環境變數設定
  □ SUPABASE_URL 已填入
  □ SUPABASE_SERVICE_KEY 已填入（生產環境使用 service_role）
  □ GEMINI_API_KEY 已填入（AI 功能可選）
  □ .env 文件已加入 .gitignore（防止上傳）

✅ 資料庫備份
  □ 已啟用 Supabase 自動備份
  □ 定期下載備份檔案存檔

✅ 存取控制
  □ Supabase Row Level Security (RLS) 已啟用
  □ API 密鑰定期輪替

✅ API 超時設定
  □ 後端 API 超時：12 秒
  □ AI 請求超時：10 秒
  □ Supabase fetch 超時：5 秒
```

---

## 📞 支援與反饋

- 📝 文件：查看 `README.md` & `README_DETAILED.md`
- 🐛 Bug 回報：提交 GitHub Issue
- 💡 功能建議：討論區發起討論
- 📧 聯絡作者：Jaa-ack (@Jaa-ack)

---

**最後更新**: 2025-12-19
**系統版本**: FruitOPS v1.0
**文件版本**: System Workflow v1.0
