# 📘 FruitOPS 系統詳細邏輯與使用文檔

本文檔詳細說明 FruitOPS 系統的**自動化計算邏輯**、**決策規則**、**功能清單**、**使用方法**、**建議流程**及**各角色使用指南**。

---

## 📑 目錄

1. [自動化計算邏輯](#自動化計算邏輯)
2. [決策規則詳解](#決策規則詳解)
3. [功能清單](#功能清單)
4. [使用方法與操作指南](#使用方法與操作指南)
5. [建議使用流程](#建議使用流程)
6. [各角色使用指南](#各角色使用指南)
7. [常見問題與最佳實踐](#常見問題與最佳實踐)

---

## 1. 自動化計算邏輯

### 1.1 RFM 客戶分級計算

**目的**：根據客戶消費行為自動分群，實現精準行銷與客戶關係管理。

**計算邏輯**：
1. **Recency（近期性）**：計算客戶最後一次購買距今天數
   - 公式：`recencyDays = (today - lastOrderDate) / (1000 * 60 * 60 * 24)`
   - 評分規則（0-5 分）：
     - ≤7 天：5 分（極活躍）
     - 8-30 天：4 分（活躍）
     - 31-90 天：3 分（普通）
     - 91-180 天：2 分（流失風險）
     - >180 天：1 分（已流失）

2. **Frequency（頻率）**：統計客戶總訂單數
   - 公式：`frequency = orders.filter(o => o.customer_name === customerName).length`
   - 評分規則（0-5 分）：
     - ≥20 筆：5 分（超高頻）
     - 10-19 筆：4 分（高頻）
     - 5-9 筆：3 分（中頻）
     - 2-4 筆：2 分（低頻）
     - 1 筆：1 分（新客）

3. **Monetary（消費金額）**：累積消費總額
   - 公式：`monetary = orders.filter(o => o.customer_name === customerName).reduce((sum, o) => sum + o.total, 0)`
   - 評分規則（0-5 分）：
     - ≥50000：5 分（超高消費）
     - 20000-49999：4 分（高消費）
     - 10000-19999：3 分（中消費）
     - 5000-9999：2 分（低消費）
     - <5000：1 分（極低消費）

4. **分級規則**：根據 RFM 三個維度綜合評分（總分 3-15 分）
   - **VIP**：總分 ≥13 分 且 M≥4 分（高消費+高活躍度）
   - **Stable（穩定客群）**：總分 9-12 分 且 R≥3 分（定期回購）
   - **New（新客）**：F=1 分 且 R≥4 分（首次購買且近期）
   - **At Risk（流失風險）**：R≤2 分 且 F≥2 分（曾購買但長時間未回購）
   - **Regular（一般客戶）**：其他情況

**API 端點**：
- `GET /api/customers/segmentation/calculate`：計算所有客戶的 RFM 分級並返回預覽
- `POST /api/customers/segmentation/apply`：將計算結果應用至資料庫

**執行時機**：每週或每月執行一次，或在需要更新客戶分級時手動觸發。

---

### 1.2 地塊健康度計算

**目的**：量化地塊生產狀況，提供預防性維護與農務決策依據。

**計算邏輯**：
1. **初始分數**：依據地塊狀態（status）設定基準分
   - 運作中（Active）：80 分
   - 維護中（Maintenance）：60 分
   - 休耕（Fallow）：40 分

2. **作業加分機制**：7 天內執行的農務作業獲得加分
   - 施肥（Fertilize）：+5 分
   - 修剪（Pruning）：+4 分
   - 噴藥（Pesticide）：+3 分
   - 套袋（Bagging）：+3 分
   - 除草（Weeding）：+2 分
   - 採收（Harvest）：+2 分
   - 每項作業加分僅計一次，多次執行不疊加

3. **時效衰減**：長時間未作業導致扣分
   - 30-60 天未作業：-5 分
   - >60 天未作業：-15 分

4. **成本效益調整**：
   - 近 30 天總成本 <500 元（低投入）：-3 分
   - 近 30 天總成本 >2000 元 且健康度 <70（高投入低產出）：-5 分

5. **季節匹配度**：檢查作物是否適合當前季節
   - 錯季種植（如冬季種植夏季水果）：-5 分

6. **最終分數限制**：0-100 分之間

**實際計算實現**：目前系統中健康度直接由資料庫 `plots.health` 欄位提供，可整合上述邏輯實現自動化更新。

**建議實現方式**：
- 每日凌晨執行自動計算腳本，更新所有地塊健康度
- 新增農務日誌時即時更新對應地塊健康度
- 提供手動觸發「重新計算健康度」功能

---

### 1.3 庫存時效分析

**目的**：依據採收日期（harvest_date）計算庫存時效，指導通路配置與促銷策略。

**計算邏輯**：
1. **時效天數計算**：
   ```javascript
   const agingDays = Math.floor((today - harvestDate) / (1000 * 60 * 60 * 24));
   ```

2. **時效分期**：
   - **新鮮期（Fresh）**：≤7 天
     - 建議通路：Direct（直接銷售）、Line
     - 建議等級：A、B 級優先
     - 策略：主打新鮮度，高價銷售
   
   - **保鮮期（Preservation）**：8-14 天
     - 建議通路：Phone（電話訂購）、Wholesale（批發）
     - 建議等級：B、C 級組合銷售
     - 策略：推薦組合優惠，維持銷售速度
   
   - **展示期（Display）**：>14 天
     - 建議通路：Wholesale（批發）、加工通路
     - 建議等級：C 級或混合等級
     - 策略：促銷清倉、降價處理、轉加工用途

3. **決策閾值**：
   - 展示期庫存 >100 單位：觸發促銷警告
   - 展示期庫存 >50 單位：建議加工通路處理
   - 新鮮期庫存 <20 單位：提醒關注採收計畫

**實現位置**：`components/Inventory.tsx` 中的時效分析區塊

---

### 1.4 訂單自動計算

**自動化功能**：
1. **訂單總額計算**：
   ```javascript
   const orderTotal = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
   ```

2. **客戶自動建立**：
   - 新增訂單時，若客戶名稱不存在於資料庫，自動建立新客戶記錄
   - 預設分級為 `Regular`，電話欄位可選填
   - API: `POST /api/customers` → `upsertCustomerByName`

3. **庫存自動扣減**：
   - 訂單確認（揀貨）時，根據品項與數量扣減對應庫存
   - 支援多儲位揀貨，前端選擇來源儲位後執行扣減
   - API: `POST /api/orders/:id/pick`

---

## 2. 決策規則詳解

### 2.1 生產管理決策規則

**地塊健康度分級建議**：
- **≥85 分（健康）**：
  - 建議：維持每 7 天巡檢、觀測病蟲害
  - 作業頻率：預防性維護
  
- **60-84 分（注意）**：
  - 建議：施肥或葉面追肥、加強病蟲監測、檢查灌溉均勻性
  - 作業頻率：每 3-5 天巡檢，重點關注

- **<60 分（警告）**：
  - 建議：優先處理病枝修剪、檢查排水/灌溉、必要時施藥
  - 作業頻率：每日巡檢，立即處理

**地塊狀態流轉建議**：
- **維護中（Maintenance）**：
  - 完成修剪/補苗/支架檢查後轉為「運作中」
  - 預計維護時間：1-2 週
  
- **休耕（Fallow）**：
  - 規劃覆蓋作物或土壤改良
  - 預計休耕時間：2-3 個月，提升下季健康度至 80 分以上

**AI 即時諮詢**：
- 點擊「諮詢 AI」按鈕，系統自動將地塊資訊（名稱、作物、健康度、狀態、近期作業）傳送至 AI
- AI 根據資訊提供具體建議（施肥時機、病蟲害防治、灌溉策略等）
- 需配置 `GEMINI_API_KEY` 環境變數

---

### 2.2 庫存管理決策規則

**通路配置策略**：
1. **新鮮期庫存（≤7天）**：
   - 優先配給 Direct/Line 通路
   - 主打 A/B 級品，強調新鮮度
   - 高價銷售策略

2. **保鮮期庫存（8-14天）**：
   - 適合 Phone/Wholesale 通路
   - 推薦組合銷售（例如混合等級禮盒）
   - 微幅折扣促進銷售

3. **展示期庫存（>14天）**：
   - 建議促銷或加工通路處理
   - C 級品或混合等級清倉
   - 大幅折扣或轉加工用途

**庫存預警機制**：
- 展示期庫存 >100 單位：觸發「臨期處理」警告
- 新鮮期庫存 =0 且無近期採收計畫：提醒關注生產排程
- 平均庫存/品項 <30 單位：提示品項庫存偏低

---

### 2.3 訂單管理決策規則

**訂單狀態流轉**：
- `Pending（待處理）` → 揀貨 → `Confirmed（已確認）`
- `Confirmed（已確認）` → 出貨 → `Shipped（已出貨）`
- `Shipped（已出貨）` → 客戶簽收 → `Completed（已完成）`
- 任何狀態 → `Cancelled（已取消）`（僅限 Pending/Confirmed 階段）

**揀貨規則**：
- 系統顯示可用庫存（依產品名稱+等級篩選）
- 前端選擇來源儲位與數量
- 必須完全匹配訂單需求數量（不允許部分揀貨）
- 揀貨完成後自動扣減庫存並更新訂單狀態

**優先處理建議**：
- 優先處理 24 小時內的新訂單
- VIP 客戶訂單優先處理
- 大量訂單（>5000 元）優先揀貨

---

### 2.4 客戶管理決策規則

**分級行動建議**：
- **VIP 客戶**：
  - 行動：優先推送預購資訊與專屬組合
  - 頻率：每週互動，季節新品提前通知
  - 通路：優先 Direct/Line，維持高頻互動

- **穩定客群（Stable）**：
  - 行動：定期推送促銷與季節新品
  - 頻率：每月 2-3 次互動
  - 目標：提升回購頻率，轉化為 VIP

- **新客戶（New）**：
  - 行動：加強關係建立，推薦當季熱銷品
  - 頻率：首購後 7 天內追蹤，引導二次購買
  - 目標：降低流失率，建立信任

- **流失風險（At Risk）**：
  - 行動：主動聯繫（電話或 LINE），提供回購優惠
  - 頻率：立即行動，1-2 週內完成挽回
  - 目標：重新激活，避免永久流失

- **一般客戶（Regular）**：
  - 行動：適時推送促銷資訊
  - 頻率：每月 1 次
  - 目標：觀察行為變化，適時調整分級

**通路偏好分析**：
- 系統自動統計客戶在各通路的訂單數與佔比
- 優先使用客戶偏好通路進行行銷推送
- 通路偏好數據顯示於客戶詳細檔案中

---

## 3. 功能清單

### 3.1 總覽（Dashboard）

**功能**：
- 即時營收、待處理訂單、低庫存品項統計
- 當月季節狀況提示（可銷售水果清單）
- 銷售通路分佈圓餅圖
- 當前庫存水位橫條圖
- 生產銷售行事曆快速查看

**說明**：
- 已移除「今日決策建議」卡片；總覽專注於季節提示與關鍵圖表。決策建議分別在各頁提供：
   - Inventory：庫存時效與通路配置建議
   - Orders：促銷優先品項與推薦客戶
   - Production：AI 即時諮詢與建議留存

---

### 3.2 智慧生產管理（Production）

**功能**：
- 地塊列表（顯示健康度、狀態、作物種類）
- 地塊狀態切換（運作中/維護中/休耕）
- 農務日誌新增/編輯（記錄作業、成本、工資、備註）
- 地塊詳細資訊展示
- **AI 即時諮詢按鈕**（無預設建議，點擊獲取針對性建議）
- 健康度計算說明（頁面底部）

**自動化內容**：
- AI 諮詢自動整合地塊資訊與近期作業記錄
- AI 建議以農務日誌 `activity = AIAdvice` 形式儲存（含 ISO 時戳），右側顯示最新建議與「最後建議時間」

**使用流程**：
1. 查看地塊健康度與狀態
2. 點擊地塊查看詳細資訊
3. 需要具體建議時點擊「諮詢 AI」獲取即時指導（系統會儲存為 AIAdvice 日誌）
4. 依建議執行作業並在「新增日誌」記錄
5. 完成作業後更新地塊狀態（如維護中→運作中）

---

### 3.3 分級庫存管理（Inventory）

**功能**：
- 庫存摘要表（產品名稱、總庫存量、級別數、位置數）
- 展開檢視（按等級分組，顯示各儲位明細，含 `harvest_date`、`package_spec`、`batch_id`、`origin_plot_id`）
- 新增庫存（選擇產品、等級、數量、儲位，並填寫採收日期；可選填包裝規格/批次/來源地塊）
- 庫存移動（跨儲位移動）
- 庫存刪除
- **庫存時效與通路配置建議**（新鮮期/保鮮期/展示期分析）
- 本週執行建議（依據時效自動生成）

**自動化內容**：
- 時效分期自動計算（依據 harvest_date）
- 通路配置建議自動生成
- 臨期警告自動觸發

**使用流程**：
1. 查看庫存摘要，快速了解總庫存與分佈
2. 展開產品查看各等級與儲位明細（可見採收日期、包裝規格、批次、來源地塊）
3. 根據「時效與通路配置建議」規劃本週銷售策略
4. 執行庫存移動（如將保鮮期品移至冷藏區）
5. 臨期品項依建議轉促銷或加工通路；新增品項時務必填 `harvest_date` 以啟用時效分析

---

### 3.4 訂單管理（Orders）

**功能**：
- 訂單列表（訂單日期、來源通路、客戶名稱、內容、總金額、狀態）
- 訂單篩選（全部/待處理/已確認/已出貨/已完成）
- 新增訂單（選擇客戶、通路、品項、等級、數量、單價），新增欄位：`來源 source`、`付款狀態 payment_status`；品項可填 `origin_plot_id`
- 客戶自動建立（訂單中不存在的客戶自動新增至資料庫）
- 揀貨功能（Pending 訂單點擊「拿取水果」選擇來源儲位並扣減庫存）
- 訂單狀態流轉（Pending → Confirmed → Shipped → Completed）
- 訂單取消（僅限 Pending/Confirmed 階段）
- 點擊客戶名稱跳轉至 CRM 客戶詳情
- **促銷優先品項與推薦客戶**：依庫存 `harvest_date` 計算展示期（>14 天）臨期品，聚合顯示需優先促銷的品項，並以 RFM 理論推薦 VIP/Stable、Regular、At Risk 客群與通路（Phone/Wholesale），提供行銷理論依據。

**自動化內容**：
- 訂單總額自動計算
- 客戶自動建立
- 揀貨時庫存自動扣減
- 訂單狀態自動流轉
- 臨期品促銷清單與推薦客群自動計算（依庫存時效與 RFM 分群）

**使用流程**：
1. 接收訂單後點擊「新增訂單」
2. 選擇客戶（若不存在則自動新增）
3. 選擇通路、品項、等級、數量、單價，並填寫 `source`/`payment_status`；必要時為品項填 `origin_plot_id`
4. 訂單建立後狀態為 `Pending`
5. 點擊「拿取水果」進行揀貨，選擇來源儲位並確認數量
6. 揀貨完成後狀態自動更新為 `Confirmed`，庫存自動扣減
7. 出貨後點擊「已出貨」，客戶簽收後點擊「已完成」

---

### 3.5 顧客關係管理（CRM）

**功能**：
- 客戶列表（顯示名稱、電話、分級、累積消費、上次購買）
- 客戶搜尋（按姓名或電話搜尋）
- 客戶詳細檔案（消費統計、通路偏好、近期消費紀錄）
- 客戶編輯（修改姓名、電話、分級，新增 `region`、`preferred_channel`）
- RFM 分級計算（點擊「計算 RFM 分級」）
- 分級預覽與應用（計算後點擊「應用分級」更新至資料庫）
- 建議行動提示（依據分級顯示行動建議）

**自動化內容**：
- RFM 分級自動計算
- 通路偏好自動統計
- 消費紀錄自動彙整
- 建議行動依分級自動生成

**使用流程**：
1. 查看客戶列表，快速了解分級分佈
2. 點擊「查看完整檔案」查看客戶詳細資訊與通路偏好
3. 定期點擊「計算 RFM 分級」更新客戶分級
4. 查看分級預覽後點擊「應用分級」更新至資料庫
5. 根據「建議行動」對不同分級客戶執行對應策略
6. 編輯客戶資訊時點擊「編輯基本資訊」修改姓名、電話、分級，並填寫地區與偏好通路

---

## 4. 使用方法與操作指南

### 4.1 如何新增訂單並完成揀貨

**步驟**：
1. 進入「訂單管理」頁面，點擊「新增訂單」
2. 填寫訂單資訊：
   - 客戶名稱：輸入或選擇現有客戶（不存在則自動新增）
   - 銷售通路：選擇 Direct/Line/Phone/Wholesale
   - 品項：點擊「➕ 新增」添加多個品項
   - 每個品項選擇：產品名稱、等級、數量、單價（系統自動帶出預設價格）
3. 點擊「✓ 新增訂單」，訂單建立成功，狀態為 `Pending`
4. 在訂單列表中找到該訂單，點擊「拿取水果」
5. 揀貨彈窗中為每個品項選擇來源儲位與數量（必須匹配需求數量）
6. 點擊「確認揀貨」，系統自動扣減庫存並更新訂單狀態為 `Confirmed`
7. 出貨後點擊「已出貨」，客戶簽收後點擊「已完成」

---

### 4.2 如何執行 RFM 客戶分級

**步驟**：
1. 進入「顧客關係管理」頁面
2. 點擊右上角「計算 RFM 分級」按鈕
3. 系統自動計算所有客戶的 Recency、Frequency、Monetary 分數
4. 分級預覽區塊顯示計算結果（包含 RFM 分數與分級）
5. 檢查分級結果無誤後，點擊「應用分級 (N)」
6. 系統將分級結果更新至資料庫，客戶列表自動刷新

**執行頻率**：
- 建議每週或每月執行一次
- 新客戶增加或重大促銷活動後執行
- 流失風險客戶需即時更新

---

### 4.3 如何使用 AI 顧問

**生產管理 AI 諮詢**：
1. 進入「智慧生產管理」頁面
2. 點擊任一地塊查看詳細資訊
3. 在右側「智慧生產建議」區塊點擊「諮詢 AI」按鈕
4. 系統自動將地塊資訊（名稱、作物、健康度、狀態、近期作業）傳送至 AI
5. AI 返回具體建議（施肥時機、病蟲害防治、灌溉策略等）

**全局 AI 顧問**：
1. 點擊右下角浮動「詢問 AI 顧問」按鈕
2. 選擇預設問題或輸入自訂問題
3. AI 根據系統資料（庫存、訂單、客戶）提供建議
4. 例如：「根據目前庫存提出促銷建議」、「分析最近的銷售趨勢並建議行動」

**注意**：需配置 `GEMINI_API_KEY` 環境變數才能使用 AI 功能。

---

### 4.4 如何管理庫存時效與通路配置

**步驟**：
1. 進入「分級庫存管理」頁面
2. 查看「庫存時效與通路配置建議」區塊
3. 系統自動顯示：
   - 新鮮期庫存（≤7天）數量與建議通路
   - 保鮮期庫存（8-14天）數量與建議通路
   - 展示期庫存（>14天）數量與處理建議
4. 根據「本週執行建議」規劃銷售策略：
   - 新鮮期優先配給 Direct/Line 通路
   - 保鮮期推薦組合銷售至 Phone/Wholesale
   - 展示期執行促銷或轉加工通路
5. 執行庫存移動（如將臨期品移至促銷區）

**注意**：
- 確保新入庫品項填寫 `harvest_date`，否則無法計算時效
- 展示期庫存 >50 單位時應立即處理，避免損耗

---

## 5. 建議使用流程

### 5.1 每日流程（果園主/倉儲）

**早上（08:00-09:00）**：
1. 登入系統，查看「總覽」頁面季節狀況提示與關鍵圖表
2. 檢查「訂單管理」，留意上方的臨期品促銷與推薦客戶清單
3. 進入「智慧生產管理」，查看地塊健康度並視需要諮詢 AI
4. 進入「分級庫存管理」，查看時效分析與臨期警告

**上午（09:00-12:00）**：
1. 執行農務作業（依據生產建議）
2. 完成後於「智慧生產管理」新增農務日誌
3. 處理待處理訂單：
   - 進入「訂單管理」，對 `Pending` 訂單執行揀貨
   - 完成揀貨後狀態自動更新為 `Confirmed`

**下午（13:00-17:00）**：
1. 出貨已確認訂單，更新狀態為 `Shipped`
2. 處理庫存移動（依據時效建議調整儲位）
3. 新增當日採收入庫（填寫產品、等級、數量、儲位、採收日期）

**傍晚（17:00-18:00）**：
1. 查看「總覽」頁面，確認當日營收與庫存狀況
2. 檢查臨期品促銷清單與庫存時效警告，規劃明日促銷策略

---

### 5.2 每週流程（業務/果園主）

**週一**：
1. 查看「生產銷售行事曆」，確認本週可銷售水果與優先策略
2. 進入「分級庫存管理」，查看時效分析，規劃本週通路配置
3. 進入「顧客關係管理」，查看 VIP 與流失風險客戶，規劃本週行動

**週三**：
1. 執行對流失風險客戶的挽回行動（電話聯繫、優惠推送）
2. 對 VIP 客戶推送本週新品或組合優惠
3. 檢查保鮮期庫存，推送組合銷售至 Phone/Wholesale 通路

**週五**：
1. 查看本週訂單統計，分析銷售通路表現
2. 檢查展示期庫存，規劃週末促銷或加工處理
3. 進入「智慧生產管理」，查看地塊健康度，規劃下週農務

---

### 5.3 每月流程（果園主/業務）

**月初（1-5 日）**：
1. 進入「顧客關係管理」，點擊「計算 RFM 分級」
2. 查看分級預覽，確認無誤後點擊「應用分級」
3. 匯出上月銷售數據與客戶分佈報表（可手動整理或使用 AI 分析）

**月中（15-20 日）**：
1. 查看「生產銷售行事曆」，確認下月可銷售水果
2. 進入「智慧生產管理」，規劃下月農務排程
3. 對新客戶執行二次購買引導行動

**月底（25-31 日）**：
1. 檢查本月營收與客戶回購率
2. 分析本月庫存周轉情況，調整下月採收與入庫計畫
3. 規劃下月促銷活動與通路策略

---

### 5.4 季節性流程（果園主）

**春季（3-5 月）**：
- 查看行事曆，確認春季水果（草莓、櫻桃、枇杷）銷售策略
- 規劃夏季水果（蜜桃、水蜜桃、黃金桃）採收與入庫
- 執行地塊維護（修剪、施肥、套袋）

**夏季（6-8 月）**：
- 主打夏季水果新鮮銷售，優先 Direct/Line 通路
- 加強冷藏管理，延長保鮮期
- 規劃秋季水果（柿子、柑橘、梨）採收計畫

**秋季（9-11 月）**：
- 執行秋季水果銷售，推薦組合禮盒
- 規劃冬季水果（草莓、柑橘）採收與入庫
- 執行年度客戶分級，對 VIP 客戶推送年末優惠

**冬季（12-2 月）**：
- 主打冬季水果與冷藏庫存
- 執行地塊休耕與土壤改良
- 規劃來年生產計畫與客戶策略

---

## 6. 各角色使用指南

### 6.1 果園主

**主要職責**：
- 決策與規劃（生產、銷售、客戶策略）
- 地塊健康監控與農務排程
- 重要訂單審核與高價值客戶維護

**每日關注**：
- 總覽頁面「季節狀況提示與圖表」
- 訂單管理「促銷優先品項與推薦客戶」
- 智慧生產管理「地塊健康度（需要時諮詢 AI）」

**每週關注**：
- 生產銷售行事曆「本週可銷售水果」
- 分級庫存管理「時效與通路配置」
- 顧客關係管理「流失風險客戶」

**每月關注**：
- RFM 客戶分級計算與應用
- 月度營收與客戶分佈分析
- 下月生產與銷售計畫

**推薦工具**：
- AI 顧問（詢問生產、銷售、成本優化建議）
- 生產銷售行事曆（季節性決策）
- RFM 客戶分級（客戶策略）

---

### 6.2 倉儲/出貨人員

**主要職責**：
- 庫存管理（入庫、移位、盤點）
- 訂單揀貨與出貨
- 庫存時效監控與臨期處理

**每日關注**：
- 訂單管理「待處理訂單」（揀貨）
- 分級庫存管理「臨期警告」
- 訂單管理「促銷優先品項與推薦客戶」

**每週關注**：
- 分級庫存管理「時效分析」
- 本週執行建議（移位、促銷）

**操作流程**：
1. 早上查看待處理訂單，規劃揀貨順序
2. 依據訂單品項與等級，選擇來源儲位執行揀貨
3. 完成揀貨後確認庫存扣減無誤
4. 檢查時效分析，執行庫存移位（如將保鮮期品移至冷藏區）
5. 出貨已確認訂單，更新狀態為「已出貨」
6. 下班前檢查臨期警告，規劃明日處理

**推薦工具**：
- 訂單管理（揀貨功能）
- 分級庫存管理（時效分析、庫存移動）
- 總覽頁面（儲位調整建議）

---

### 6.3 業務人員

**主要職責**：
- 接單與客戶溝通
- 客戶關係維護（VIP、新客、流失風險）
- 通路推廣與促銷執行

**每日關注**：
- 訂單管理「新增訂單」
- 顧客關係管理「客戶搜尋」
- 訂單管理「促銷優先品項與推薦客戶」

**每週關注**：
- 顧客關係管理「VIP 客戶」、「流失風險客戶」
- 分級庫存管理「本週執行建議」
- 生產銷售行事曆「本週可銷售水果」

**操作流程**：
1. 接收客戶訂單後，進入「訂單管理」新增訂單
2. 選擇客戶（不存在則自動新增）、通路、品項、等級、數量、單價
3. 訂單建立後通知倉儲執行揀貨
4. 查看客戶詳細檔案，了解消費統計與通路偏好
5. 根據客戶分級執行對應行動：
   - VIP：推送預購與專屬組合
   - 流失風險：主動聯繫，提供回購優惠
   - 新客：引導二次購買，推薦熱銷品
6. 規劃本週促銷策略，依據時效分析推廣臨期品

**推薦工具**：
- 訂單管理（新增訂單、客戶跳轉）
- 顧客關係管理（客戶詳情、分級行動建議）
- AI 顧問（撰寫客戶問候簡訊、促銷文案）

---

## 7. 常見問題與最佳實踐

### Q1: 如何確保庫存時效計算準確？

**A**：
- 入庫時務必填寫 `harvest_date`（採收日期）
- 採收當日入庫，避免日期誤差
- 定期檢查庫存明細，確認無遺漏或錯誤日期

---

### Q2: RFM 分級計算結果不符預期怎麼辦？

**A**：
- 檢查訂單資料完整性（客戶名稱、日期、總金額）
- 確認分級閾值符合實際業務情況（可於 `server/index.js` 調整）
- 手動調整個別客戶分級（進入客戶詳情點擊「編輯基本資訊」）

---

### Q3: 揀貨時找不到可用庫存怎麼辦？

**A**：
- 檢查產品名稱與等級是否完全匹配
- 確認庫存數量足夠（展開產品查看各儲位明細）
- 若庫存不足，通知倉儲補貨或聯繫客戶調整訂單

---

### Q4: AI 顧問無法使用怎麼辦？

**A**：
- 檢查 `.env` 檔案是否配置 `GEMINI_API_KEY`
- 確認 API Key 有效且未過期
- 檢查網路連線是否正常
- 若無 API Key，可前往 [Google AI Studio](https://aistudio.google.com/app/apikey) 申請

---

### Q5: 如何避免庫存過期損耗？

**A**：
- 每日檢查「時效與通路配置建議」
- 展示期庫存 >50 單位時立即處理
- 設定每週固定促銷日，清理臨期品
- 與加工廠合作，轉化臨期品為果醬、果乾等加工品

---

### 最佳實踐建議

1. **每日例行檢查**：
   - 總覽季節提示與圖表 → 訂單管理待處理 + 促銷清單 → 庫存時效警告

2. **每週固定作業**：
   - 週一：查看行事曆規劃本週策略
   - 週三：執行客戶維護行動
   - 週五：檢查庫存與規劃促銷

3. **每月必做項目**：
   - 月初：RFM 分級計算與應用
   - 月中：下月生產與銷售計畫
   - 月底：本月數據分析與總結

4. **資料維護**：
   - 確保訂單資料完整（客戶名稱、通路、日期、金額）
   - 庫存入庫時填寫採收日期
   - 農務日誌記錄詳細（作業、成本、備註）

5. **善用 AI 輔助**：
   - 不確定決策時詢問 AI 顧問
   - 使用 AI 撰寫客戶問候簡訊
   - 請 AI 分析銷售趨勢與成本優化

---

## 資料庫與遷移

**結構概覽**：
- `customers`：客戶基本資料（含 `segment` 以支援 RFM）
- `orders` / `order_items`：訂單與明細（外鍵約束）
- `inventory`：庫存（含關鍵欄位 `harvest_date`）
- `storage_locations`：儲位/倉位資料
- `plots`：地塊資料（供生產管理）
- `logs`：農務日誌與系統記錄（含 AIAdvice）
- `product_grades`：品名 x 等級字典

**遷移檔**：`server/migrations/004_rebuild_marketing.sql`
- 作用：完整重建上述資料表並載入豐富的示範資料，便於測試促銷與分群邏輯。

**主要欄位與邏輯**：
- `inventory.harvest_date`：作為時效計算基礎；
   - Fresh ≤ 7 天 → 直售/Line
   - Preservation 8–14 天 → Phone/Wholesale
   - Display > 14 天 → 批發/加工（促銷優先）
- `logs.activity = 'AIAdvice'`：儲存 AI 諮詢建議；含 ISO 格式 `created_at` 以顯示「最後建議時間」。
- `orders` 與 `order_items`：維持外鍵一致性與金額統計，示範資料包含多客群、多品項情境。
- `product_grades`：規範可用的品名/等級，便於庫存與訂單對齊。

**示範資料內容**：
- 客戶涵蓋 `VIP/Stable`、`Regular`、`At Risk` 等分群，支援行銷建議展示。
- 儲位包含常見區位，庫存資料覆蓋多種 `harvest_date` 以驗證時效分期。
- 日誌包含多筆一般作業與 `AIAdvice` 範例；地塊資料涵蓋不同作物與狀態。
- 訂單與明細模擬多樣出貨場景（小訂/大訂/促銷組合）。

**套用方式**：
- Supabase SQL Editor：開啟專案 → SQL Editor → 貼上 `004_rebuild_marketing.sql` 全文 → 執行。
- psql（自行連線）：
   - 取得資料庫連線字串（`postgres://...`）
   - 在終端機執行：`psql "<connection_string>" -f server/migrations/004_rebuild_marketing.sql`

**注意事項**：
- 於正式環境執行前請先備份資料並確認影響範圍。
- 確保環境變數（Supabase URL/Key）設定正確，避免誤用測試資料覆蓋正式庫。
- 若已有自訂資料字典，請先比對 `product_grades` 差異再執行。

**前端對應**：
- Production：讀取 `logs` 中最新的 `AIAdvice` 並顯示「最後建議時間」。
- Orders：依 `inventory.harvest_date` 計算臨期品，生成「促銷優先品項與推薦客戶」。
- Inventory：呈現 Fresh/Preservation/Display 三分期與建議通路配置。

## 結語

FruitOPS 系統透過自動化計算與智能決策，將果園營運流程數位化，減少人工判斷負擔，提升營運效率。本文檔提供完整的邏輯說明與使用指南，建議列印或保存為參考手冊，協助團隊快速上手並發揮系統最大價值。

如有任何問題或建議，歡迎聯繫系統管理員或查看 `README.md` 了解更多技術細節。
